# LogicTest: fakedist fakedist-opt fakedist-metadata

statement ok
CREATE TABLE data (a INT, b INT, c FLOAT, d DECIMAL, PRIMARY KEY (a, b, c), INDEX d_idx (d))

# Enable automatic stats
statement ok
SET CLUSTER SETTING sql.stats.experimental_automatic_collection.enabled = true

# Generate all combinations of values 1 to 10.
statement ok
INSERT INTO data SELECT a, b, c::FLOAT, NULL FROM
   generate_series(1, 10) AS a(a),
   generate_series(1, 10) AS b(b),
   generate_series(1, 10) AS c(c)

query TTIII colnames,rowsort,retry
SELECT statistics_name, column_names, row_count, distinct_count, null_count
FROM [SHOW STATISTICS FOR TABLE data] ORDER BY column_names::STRING, created
----
statistics_name  column_names  row_count  distinct_count  null_count
__auto__         {a}           1000       10              0
__auto__         {b}           1000       10              0
__auto__         {c}           1000       10              0
__auto__         {d}           1000       0               1000

# Disable automatic stats
statement ok
SET CLUSTER SETTING sql.stats.experimental_automatic_collection.enabled = false

# Update more than 10% of the table.
statement ok
UPDATE data SET d = 10 WHERE (a = 1 OR a = 2) AND b > 1

# There should be no change to stats.
query TTIII colnames,rowsort
SELECT statistics_name, column_names, row_count, distinct_count, null_count
FROM [SHOW STATISTICS FOR TABLE data] ORDER BY column_names::STRING, created
----
statistics_name  column_names  row_count  distinct_count  null_count
__auto__         {a}           1000       10              0
__auto__         {b}           1000       10              0
__auto__         {c}           1000       10              0
__auto__         {d}           1000       0               1000

# Enable automatic stats
statement ok
SET CLUSTER SETTING sql.stats.experimental_automatic_collection.enabled = true

# Update more than 10% of the table.
statement ok
UPDATE data SET d = 12 WHERE d = 10

query TTIII colnames,rowsort,retry
SELECT statistics_name, column_names, row_count, distinct_count, null_count
FROM [SHOW STATISTICS FOR TABLE data] ORDER BY column_names::STRING, created
----
statistics_name  column_names  row_count  distinct_count  null_count
__auto__         {a}           1000       10              0
__auto__         {a}           1000       10              0
__auto__         {b}           1000       10              0
__auto__         {b}           1000       10              0
__auto__         {c}           1000       10              0
__auto__         {c}           1000       10              0
__auto__         {d}           1000       0               1000
__auto__         {d}           1000       1               820

# Upsert more than 10% of the table.
statement ok
UPSERT INTO data SELECT a, b, 1, 1 FROM
generate_series(1, 11) AS a(a),
generate_series(1, 10) AS b(b)

query TTIII colnames,rowsort,retry
SELECT statistics_name, column_names, row_count, distinct_count, null_count
FROM [SHOW STATISTICS FOR TABLE data] ORDER BY column_names::STRING, created
----
statistics_name  column_names  row_count  distinct_count  null_count
__auto__         {a}           1000       10              0
__auto__         {a}           1000       10              0
__auto__         {a}           1010       11              0
__auto__         {b}           1000       10              0
__auto__         {b}           1000       10              0
__auto__         {b}           1010       10              0
__auto__         {c}           1000       10              0
__auto__         {c}           1000       10              0
__auto__         {c}           1010       10              0
__auto__         {d}           1000       0               1000
__auto__         {d}           1000       1               820
__auto__         {d}           1010       2               738

# Delete more than 10% of the table.
statement ok
DELETE FROM data WHERE c > 5

query TTIII colnames,rowsort,retry
SELECT statistics_name, column_names, row_count, distinct_count, null_count
FROM [SHOW STATISTICS FOR TABLE data] ORDER BY column_names::STRING, created
----
statistics_name  column_names  row_count  distinct_count  null_count
__auto__         {a}           1000       10              0
__auto__         {a}           1000       10              0
__auto__         {a}           1010       11              0
__auto__         {a}           510        11              0
__auto__         {b}           1000       10              0
__auto__         {b}           1000       10              0
__auto__         {b}           1010       10              0
__auto__         {b}           510        10              0
__auto__         {c}           1000       10              0
__auto__         {c}           1000       10              0
__auto__         {c}           1010       10              0
__auto__         {c}           510        5               0
__auto__         {d}           1000       0               1000
__auto__         {d}           1000       1               820
__auto__         {d}           1010       2               738
__auto__         {d}           510        2               328

# Test CREATE TABLE ... AS
statement ok
CREATE TABLE copy AS SELECT * FROM data

# Distinct count for rowid can be flaky, so don't show it. The estimate is
# almost always 510, but occasionally it is 509...
query TTII colnames,rowsort,retry
SELECT statistics_name, column_names, row_count, null_count
FROM [SHOW STATISTICS FOR TABLE copy] ORDER BY column_names::STRING, created
----
statistics_name  column_names  row_count  null_count
__auto__         {a}           510        0
__auto__         {b}           510        0
__auto__         {c}           510        0
__auto__         {d}           510        328
__auto__         {rowid}       510        0

# Test fast path delete.
statement ok
DELETE FROM copy WHERE true

query TTII colnames,rowsort,retry
SELECT statistics_name, column_names, row_count, null_count
FROM [SHOW STATISTICS FOR TABLE copy] ORDER BY column_names::STRING, created
----
statistics_name  column_names  row_count  null_count
__auto__         {a}           510        0
__auto__         {a}           0          0
__auto__         {b}           510        0
__auto__         {b}           0          0
__auto__         {c}           510        0
__auto__         {c}           0          0
__auto__         {d}           510        328
__auto__         {d}           0          0
__auto__         {rowid}       510        0
__auto__         {rowid}       0          0
